# Pic2Product

**Pic2Product** is an image-to-product recommendation demo powered by AI.  
A user uploads an image â†’ the backend detects products â†’ retrieves the most similar SKUs from a local catalog â†’ the frontend displays bounding boxes and recommendations.

## Architecture Overview

```
Shopper â”€â†’ React Frontend (Vite) â”€â†’ FastAPI (/recommend, /catalog/*)
                                          â”‚
                                          â”‚ YOLOv8 detection + CLIP embeddings
                                          â†“
                              local catalog.csv + embeddings/*.npz
```

- Uploaded images & visualizations â†’ `runs/`
- Product images â†’ `catalog/images/`
- Product metadata â†’ `catalog/catalog.csv`
- Cached embeddings â†’ `embeddings/catalog_embeddings.npz`

## Repository Structure

| Path               | Description                                                              |
| ------------------ | ------------------------------------------------------------------------ |
| `api.py`           | FastAPI app (`/recommend`, `/catalog/rebuild`, `/catalog/query`)         |
| `mvp_reco.py`      | YOLO + CLIP inference and visualization logic                            |
| `data_merge.py`    | Merge ABO metadata + images into your local catalog CSV & image folder   |
| `catalog/`         | CSV + product images, including a csv of `sku_id,title,brand,image_path` |
| `embeddings/`      | Cached embeddings                                                        |
| `runs/`            | Uploaded images & visual output                                          |
| `frontend/`        | React + Vite ï¼ˆ`npm run dev` â†’ http://localhost:5173ï¼‰                   |
| `requirements.txt` | Dependencies                                                             |

## Data Processing Flow

1. YOLOv8 detects each instance in the image and crops the ROI.
2. The cropped image is encoded to generate an image vector, which is then fused and matched with CLIP text vectors from the catalog to obtain Top-K SKUs.
3. Prediction results are written to the `runs` directory (uploaded original image + visualization with bounding boxes).
4. The frontend fetches additional fields (price, description, image links) via `/catalog/query` and renders the cards.

## Environment Requirements

- Python **3.10+**
- Node.js **18+**
- 8GB RAM minimum
- GPU optional

## How to use

### 1. Dataset Setup (Amazon Berkeley Objects)

Pic2Product uses a local product catalog and builds a CLIP vector index.

To quickly obtain a large product catalog, we recommend using publicly available catalog images and listing metadata from the [Amazon Berkeley Objects (ABO)](https://amazon-berkeley-objects.s3.amazonaws.com/index.html) dataset.

The following explains how to download ABO, prepare the file structure, and perform data merging.

> âš ï¸ License Notice: The ABO dataset uses the CC BY-NC 4.0 (Attribution-NonCommercial) license and is only suitable for non-commercial use. Please confirm that your use case complies with these requirements before use.RetryTo run code, enable code execution and file creation in Settings > Capabilities.

#### 1. Download the Amazon Berkeley Objects Dataset

From the repository root directory, navigate to the `catalog` directory:

```bash
cd Pic2Product/catalog
```

ABO official homepage:

ðŸ‘‰ https://amazon-berkeley-objects.s3.us-east-1.amazonaws.com/index.html

Please download the following two components (minimum viable version):

âœ” abo-images-small/

Contains product main images scaled to 256px, along with images.csv.gz (image metadata).

âœ” abo-listings/

Contains listings\_\*.json.gz (product metadata), which includes fields such as:

- item_id
- brand
- item_name
- main_image_id

#### 2. Place Data in the Project Directory

```bash
# Extract to the location specified by this project
tar xf abo-images-small.tar   # Results in ./abo-images-small/...
tar xf abo-listings.tar       # Results in ./abo-listings/...
```

After extraction, the directory structure should look approximately like this:

```bash
Pic2Product/
â”‚
â”œâ”€â”€ catalog/
â”‚   â”œâ”€â”€ images/            â† All final SKU images go here
â”‚   â”œâ”€â”€ catalog.csv        â† Final product metadata (generated by data_merge.py)
â”‚   â”‚
â”‚   â”œâ”€â”€ abo-images-small/  â† Downloaded from ABO
â”‚   â”‚     â””â”€â”€ images/
â”‚   â”‚         â”œâ”€â”€ small/
â”‚   â”‚         â””â”€â”€ metadata/images.csv.gz
â”‚   â”‚
â”‚   â”œâ”€â”€ abo-listings/      â† Downloaded from ABO
â”‚         â””â”€â”€ listings/
â”‚             â””â”€â”€ metadata/listings_*.json.gz
â”‚
â”œâ”€â”€ data_merge.py          â† Merge script (generates catalog.csv + copies images)
â”œâ”€â”€ api.py
â””â”€â”€ ...
```

âš  Note: A large number of new images will be written to catalog/images/. Please ensure sufficient disk space (>3.20 GB) is available.RetryTo run code, enable code execution and file creation in Settings > Capabilities.

#### 3. Run the Merge Script

Run from the project root directory:

```bash
cd Pic2Product
python data_merge.py
```

The script will:

Read your local catalog/catalog.csv

Read ABO listings and images metadata

For each ABO listing:

    Generate a safe sku_id (e.g., abo_amazon_com_B075X4QMX3)
    Select appropriate language for title and brand
    Match the corresponding main_image_id
    Copy the image to: catalog/images/<sku_id>.jpgRetryTo run code, enable code execution and file creation in Settings > Capabilities.

Write all results back to:

    catalog/catalog.csv   â† Overwrites the original file (local only, won't be uploaded to GitHub)

Catalog storage:

```
catalog/catalog.csv â†’ loaded into SQLite catalog/catalog.db (products table)
```

Run:

```
python scripts/init_db_from_csv.py
```

### 2. Backend Setup (FastAPI)

#### 1. Create Environment & Install Dependencies

```bash
cd Pic2Product
python -m venv .venv
source .venv/bin/activate # Windows use .venv\Scripts\activate

pip install -r requirements.txt
```

> If GPU is needed, you can separately install the matching version of `torch`/`torchvision` according to your platform.RetryTo run code, enable code execution and file creation in Settings > Capabilities.

#### 2. Prepare Catalog (see 1. Dataset setup)

make sure you have:
YOLO model: yolov8n.pt

1. `catalog/catalog.csv`: Provides SKU metadata and image path (to the catalog)
2. `catalog/images/`: Corresponds to the `image_path` in the CSV.
3. `yolov8n.pt`: Already included in the repository, but can be replaced with a larger model.

#### 3. Start the API

```bash
uvicorn api:app --host 0.0.0.0 --port 8000 --reload
# or
python api.py
```

Common environment variables (can be set in `.env` or shell):

| Variable         | Default Value         | Description                                    |
| ---------------- | --------------------- | ---------------------------------------------- |
| `CATALOG_CSV`    | `catalog/catalog.csv` | CSV path                                       |
| `EMBEDDINGS_DIR` | `embeddings`          | Directory for caching npz/json files           |
| `RUNS_DIR`       | `runs`                | Uploaded images and visualizations             |
| `STATIC_DIR`     | `catalog`             | Root directory mounted as `/static` in FastAPI |
| `TOPK`           | `3`                   | Default number of SKUs returned by /recommend  |

#### 4. Rebuild Catalog Embeddings (Required for First Run)

You need to rebuild the CLIP embedding index:

```bash
curl -X POST http://localhost:8000/catalog/rebuild \
     -H "Content-Type: application/json" \
     -d '{"force": true}'
```

The API will automatically:

- Read the new catalog/catalog.csv
- Load all images (will print [WARN] image not found if not found)
- Generate embedding cache: embeddings/catalog_embeddings.npz

After the API starts, you can view the Swagger documentation at `http://localhost:8000/docs`.

Common Issues (Warnings):

âš  [WARN] image not found: catalog/images/go_B0876X42NW.jpg

This type of warning indicates:

- The main_image_id exists in the listings
- But the corresponding image file is missing in ABO (or metadata is incomplete)

This is typically an issue with the original ABO data and can be ignored.
These products will not be added to the embeddings and will not affect normal functionality.

### 3. API Overview

| Endpoint           | Method | Description                                                                                                                |
| ------------------ | ------ | -------------------------------------------------------------------------------------------------------------------------- |
| `/health`          | GET    | Check if models and catalog are ready.                                                                                     |
| `/catalog/rebuild` | POST   | Rebuild (or load cached) vector database, body: `{ "force": bool, "catalog_csv": "path" }`.                                |
| `/catalog/query`   | POST   | Return metadata based on SKU list.                                                                                         |
| `/recommend`       | POST   | Upload image via form field `image`, optional `topk`, `alpha_img`. Returns detection boxes, Top-K SKUs, and visualization. |

Example: Upload image and get recommendations

```bash

```

Example response:

```json
{
  "image_url": "/runs/uploads/1716524123456_demo.jpg",
  "vis_url": "/runs/1716524123456_demo_vis.jpg",
  "instances": [
    {
      "bbox": [77, 90, 240, 380],
      "class": "bag",
      "top_k": [
        { "sku_id": "SKU001", "title": "...", "brand": "...", "score": 0.87 }
      ]
    }
  ]
}
```

Automatic FastAPI mounts:

- `/static/...` points to `catalog` (product images).
- `/runs/...` points to uploaded images and visualization results.

### 4. Frontend (React + Vite)

The frontend runs on `http://localhost:5173` by default and uses `VITE_API_BASE_URL` to specify the backend address.

check api status:

```bash
curl http://localhost:8000/health
```

### 1. Install Dependencies

```bash
cd frontend
npm install
```

### 2. Configure API Address

Create `frontend/.env.local` (or `.env`):

```
VITE_API_BASE_URL=http://localhost:8000
```

### 3. Start/Build

```bash
# Development with hot reload
npm run dev

# Build for production
npm run build

# Preview build results
npm run preview
```

The frontend will automatically request `/recommend` and `/catalog/query`, and convert relative paths like `/static` and `/runs` to accessible URLs with the `VITE_API_BASE_URL` prefix.

## Common Issues

- **"Catalog not ready" at runtime**: Call `/catalog/rebuild` first.
- **Outdated vector cache**: Delete `embeddings/*.npz` and `embeddings/catalog_index.json`, then rebuild.
- **Image path 404**: Ensure `image_path` in CSV points to files within `catalog/`, or modify `STATIC_DIR`.
- **Frontend cannot access static resources**: Verify that `VITE_API_BASE_URL` in `.env.local` matches the backend port.RetryTo run code, enable code execution and file creation in Settings > Capabilities.
